using HomologyInferenceWithWeakFeatureSize
using HomotopyContinuation
using Printf

# ============================================================
# Settings
# ============================================================

const MAX_ORDER = 2
const THRESH = 1e-8
const USE_MONODROMY = false

# ============================================================
# Helper function
# ============================================================

function run_example(name, F)
    start_time = time()

    wfs = compute_weak_feature_size(
        F;
        maximum_bottleneck_order = MAX_ORDER,
        threshold = THRESH,
        solve_with_monodromy = USE_MONODROMY
    )

    elapsed = time() - start_time

    return (
        name = name,
        dim = length(variables(F[1])),
        wfs = wfs,
        time = elapsed
    )
end

# ============================================================
# Main benchmark
# ============================================================

function main()

    println("\nRunning Edwards weak feature size benchmarks\n")

    @var x y z

    results = []

    # ------------------------------------------------------------
    # M1
    # ------------------------------------------------------------
    F1 = [x^2 + y^2 - 1]
    push!(results, run_example("M1", F1))

    # ------------------------------------------------------------
    # M2
    # ------------------------------------------------------------
    F2 = [(x^3 - x*y^2 + y + 1)^2 * (x^2 + y^2 - 1) + y^2 - 5]
    push!(results, run_example("M2", F2))

    # ------------------------------------------------------------
    # M3
    # ------------------------------------------------------------
    F3 = [x^4 - x^2*y^2 + y^4 - 4x^2 - 2y^2 - x - 4y + 1]
    push!(results, run_example("M3", F3))

    # ------------------------------------------------------------
    # M4 (3D)
    # ------------------------------------------------------------
    F4 = [4x^2 + 7y^4 + 3z^4 - 3
          - 8x^3 + 2x^2*y - 4x^2
          - 8x*y^2 - 5x*y + 8x
          - 6y^3 + 8y^2 + 4y]
    push!(results, run_example("M4", F4))

    # ------------------------------------------------------------
    # M5
    # ------------------------------------------------------------
    P30 = sum(x^(2k) * y^(30 - 2k) for k in 0:15)
    F5 = [x^2 + y^2 - 1 + 1e-5 * P30]
    push!(results, run_example("M5", F5))

    # ------------------------------------------------------------
    # M6
    # ------------------------------------------------------------
    F6 = [(x^2 + 2y^2 - 1) * (x^2 + 2y^2 - 3 - 1e-5)]
    push!(results, run_example("M6", F6))

    # ============================================================
    # Print summary table
    # ============================================================

    println("------------------------------------------------------------")
    @printf("%-4s %-3s %-18s %-10s\n",
            "ID", "N", "wfs_lower_bound", "time(s)")
    println("------------------------------------------------------------")

    for r in results
        @printf("%-4s %-3d %-18.10e %-10.4f\n",
                r.name,
                r.dim,
                r.wfs,
                r.time)
    end

    println("------------------------------------------------------------\n")
end

main()
